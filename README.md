
<!-- README.md is generated from README.Rmd. Please edit that file -->

# pyramidi

<!-- badges: start -->

[![Travis build
status](https://travis-ci.com/urswilke/pyramidi.svg?branch=master)](https://travis-ci.com/urswilke/pyramidi)
[![Codecov test
coverage](https://codecov.io/gh/urswilke/pyramidi/branch/master/graph/badge.svg)](https://codecov.io/gh/urswilke/pyramidi?branch=master)
<!-- badges: end -->

**Work in progress\!**

The goal of pyramidi is to read in dataframes generated by the python
package [miditapyr](https://pypi.org/project/miditapyr/). These
dataframes contain midi data. Then the midi information (one line per
event) can be translated into a wide format (one line per note). This
facilitates plotting piano roll plots. These dataframes can then be
written back to midi files (again using miditapyr).

## Installation

You can install pyramidi from
[github](https://github.com/urswilke/pyramidi) with:

``` r
## install remotes package if it's not already
if (!requireNamespace("remotes", quietly = TRUE)) {
  install.packages("remotes")
}

## install dev version of rtweettree from github
remotes::install_github("UrsWilke/pyramidi")
```

The python package [miditapyr](https://pypi.org/project/miditapyr/) also
needs to be installed via

``` sh
pip install miditapyr
```

in your virtual environment.

## Basic usage

### Load libraries

``` r
library(pyramidi)
library(tidyverse)
library(zeallot)
mt <- reticulate::import("miditapyr")
mido <- reticulate::import("mido")
```

### Extract midi file information into dataframe

``` r
midi_file_str <- system.file("extdata", "test_midi_file.mid", package = "pyramidi")

midifile <- mido$MidiFile(midi_file_str)
ticks_per_beat <- midifile$ticks_per_beat

dfc = mt$midi_to_df(midifile)
head(dfc, 20)
#>    i_track  meta                              msg
#> 1        0  TRUE      track_name, drum-t1-1-t1, 0
#> 2        0  TRUE instrument_name, drum-t1-1-t1, 0
#> 3        0  TRUE            channel_prefix, 10, 0
#> 4        0  TRUE             set_tempo, 666667, 0
#> 5        0  TRUE   time_signature, 4, 4, 24, 8, 0
#> 6        0 FALSE     note_off, 312000, 36, 101, 9
#> 7        0 FALSE           note_off, 0, 43, 72, 9
#> 8        0 FALSE           note_off, 0, 39, 64, 9
#> 9        0 FALSE        note_on, 4800, 38, 101, 9
#> 10       0 FALSE           note_on, 0, 42, 101, 9
#> 11       0 FALSE       note_off, 4800, 38, 101, 9
#> 12       0 FALSE          note_off, 0, 42, 101, 9
#> 13       0 FALSE            note_on, 0, 43, 64, 9
#> 14       0 FALSE        note_off, 4800, 43, 64, 9
#> 15       0 FALSE           note_on, 0, 36, 101, 9
#> 16       0 FALSE       note_off, 4800, 36, 101, 9
#> 17       0 FALSE         note_on, 4800, 43, 60, 9
#> 18       0 FALSE           note_on, 0, 42, 101, 9
#> 19       0 FALSE        note_off, 4800, 43, 60, 9
#> 20       0 FALSE          note_off, 0, 42, 101, 9
```

``` r
ticks_per_beat
#> [1] 19200
```

``` r
df = mt$tidy_df(dfc)
head(df, 20)
#>    i_track  meta            type         name   time channel  tempo numerator
#> 1        0  TRUE      track_name drum-t1-1-t1      0     NaN    NaN       NaN
#> 2        0  TRUE instrument_name drum-t1-1-t1      0     NaN    NaN       NaN
#> 3        0  TRUE  channel_prefix          NaN      0      10    NaN       NaN
#> 4        0  TRUE       set_tempo          NaN      0     NaN 666667       NaN
#> 5        0  TRUE  time_signature          NaN      0     NaN    NaN         4
#> 6        0 FALSE        note_off          NaN 312000       9    NaN       NaN
#> 7        0 FALSE        note_off          NaN      0       9    NaN       NaN
#> 8        0 FALSE        note_off          NaN      0       9    NaN       NaN
#> 9        0 FALSE         note_on          NaN   4800       9    NaN       NaN
#> 10       0 FALSE         note_on          NaN      0       9    NaN       NaN
#> 11       0 FALSE        note_off          NaN   4800       9    NaN       NaN
#> 12       0 FALSE        note_off          NaN      0       9    NaN       NaN
#> 13       0 FALSE         note_on          NaN      0       9    NaN       NaN
#> 14       0 FALSE        note_off          NaN   4800       9    NaN       NaN
#> 15       0 FALSE         note_on          NaN      0       9    NaN       NaN
#> 16       0 FALSE        note_off          NaN   4800       9    NaN       NaN
#> 17       0 FALSE         note_on          NaN   4800       9    NaN       NaN
#> 18       0 FALSE         note_on          NaN      0       9    NaN       NaN
#> 19       0 FALSE        note_off          NaN   4800       9    NaN       NaN
#> 20       0 FALSE        note_off          NaN      0       9    NaN       NaN
#>    denominator clocks_per_click notated_32nd_notes_per_beat note velocity
#> 1          NaN              NaN                         NaN  NaN      NaN
#> 2          NaN              NaN                         NaN  NaN      NaN
#> 3          NaN              NaN                         NaN  NaN      NaN
#> 4          NaN              NaN                         NaN  NaN      NaN
#> 5            4               24                           8  NaN      NaN
#> 6          NaN              NaN                         NaN   36      101
#> 7          NaN              NaN                         NaN   43       72
#> 8          NaN              NaN                         NaN   39       64
#> 9          NaN              NaN                         NaN   38      101
#> 10         NaN              NaN                         NaN   42      101
#> 11         NaN              NaN                         NaN   38      101
#> 12         NaN              NaN                         NaN   42      101
#> 13         NaN              NaN                         NaN   43       64
#> 14         NaN              NaN                         NaN   43       64
#> 15         NaN              NaN                         NaN   36      101
#> 16         NaN              NaN                         NaN   36      101
#> 17         NaN              NaN                         NaN   43       60
#> 18         NaN              NaN                         NaN   42      101
#> 19         NaN              NaN                         NaN   43       60
#> 20         NaN              NaN                         NaN   42      101
#>    program
#> 1      NaN
#> 2      NaN
#> 3      NaN
#> 4      NaN
#> 5      NaN
#> 6      NaN
#> 7      NaN
#> 8      NaN
#> 9      NaN
#> 10     NaN
#> 11     NaN
#> 12     NaN
#> 13     NaN
#> 14     NaN
#> 15     NaN
#> 16     NaN
#> 17     NaN
#> 18     NaN
#> 19     NaN
#> 20     NaN
```

``` r
dfm <- tab_measures(df, ticks_per_beat)
#> Warning: Problem with `mutate()` input `t`.
#> ℹ longer object length is not a multiple of shorter object length
#> ℹ Input `t` is `.data$ticks * get_ticks2second_scale(df, ticks_per_beat)`.
#> ℹ The error occurred in group 2: i_track = 1.
#> Warning in .data$ticks * get_ticks2second_scale(df, ticks_per_beat): longer
#> object length is not a multiple of shorter object length
#> Warning: Problem with `mutate()` input `t`.
#> ℹ longer object length is not a multiple of shorter object length
#> ℹ Input `t` is `.data$ticks * get_ticks2second_scale(df, ticks_per_beat)`.
#> ℹ The error occurred in group 3: i_track = 2.
#> Warning in .data$ticks * get_ticks2second_scale(df, ticks_per_beat): longer
#> object length is not a multiple of shorter object length
#> Warning: Problem with `mutate()` input `m`.
#> ℹ longer object length is not a multiple of shorter object length
#> ℹ Input `m` is `t * get_bpm(df)/60`.
#> ℹ The error occurred in group 2: i_track = 1.
#> Warning in t * get_bpm(df): longer object length is not a multiple of shorter
#> object length
#> Warning: Problem with `mutate()` input `m`.
#> ℹ longer object length is not a multiple of shorter object length
#> ℹ Input `m` is `t * get_bpm(df)/60`.
#> ℹ The error occurred in group 3: i_track = 2.
#> Warning in t * get_bpm(df): longer object length is not a multiple of shorter
#> object length
```

``` r
dfm %>% 
    mt$split_df()  %->% c(df_meta, df_notes)
```

``` r
df_meta
#>     i_track meta            type         name time channel  tempo numerator
#> 0         0 TRUE      track_name drum-t1-1-t1    0     NaN    NaN       NaN
#> 1         0 TRUE instrument_name drum-t1-1-t1    0     NaN    NaN       NaN
#> 2         0 TRUE  channel_prefix          NaN    0      10    NaN       NaN
#> 3         0 TRUE       set_tempo          NaN    0     NaN 666667       NaN
#> 4         0 TRUE  time_signature          NaN    0     NaN    NaN         4
#> 158       0 TRUE    end_of_track          NaN    0     NaN    NaN       NaN
#> 159       1 TRUE      track_name         bass    0     NaN    NaN       NaN
#> 160       1 TRUE instrument_name         bass    0     NaN    NaN       NaN
#> 162       1 TRUE       set_tempo          NaN    0     NaN 666667       NaN
#> 163       1 TRUE  time_signature          NaN    0     NaN    NaN         4
#> 189       1 TRUE    end_of_track          NaN    0     NaN    NaN       NaN
#> 190       2 TRUE      track_name         keys    0     NaN    NaN       NaN
#> 191       2 TRUE instrument_name         keys    0     NaN    NaN       NaN
#> 193       2 TRUE       set_tempo          NaN    0     NaN 666667       NaN
#> 194       2 TRUE  time_signature          NaN    0     NaN    NaN         4
#> 278       2 TRUE    end_of_track          NaN    0     NaN    NaN       NaN
#>     denominator clocks_per_click notated_32nd_notes_per_beat  ticks        t  m
#> 0           NaN              NaN                         NaN      0  0.00000  0
#> 1           NaN              NaN                         NaN      0  0.00000  0
#> 2           NaN              NaN                         NaN      0  0.00000  0
#> 3           NaN              NaN                         NaN      0  0.00000  0
#> 4             4               24                           8      0  0.00000  0
#> 158         NaN              NaN                         NaN 614400 21.33334 32
#> 159         NaN              NaN                         NaN      0  0.00000  0
#> 160         NaN              NaN                         NaN      0  0.00000  0
#> 162         NaN              NaN                         NaN      0  0.00000  0
#> 163           4               24                           8      0  0.00000  0
#> 189         NaN              NaN                         NaN 614400 21.33334 32
#> 190         NaN              NaN                         NaN      0  0.00000  0
#> 191         NaN              NaN                         NaN      0  0.00000  0
#> 193         NaN              NaN                         NaN      0  0.00000  0
#> 194           4               24                           8      0  0.00000  0
#> 278         NaN              NaN                         NaN 614400 21.33334 32
#>       b i_note
#> 0     0      0
#> 1     0      0
#> 2     0      0
#> 3     0      0
#> 4     0      0
#> 158 128      0
#> 159   0      0
#> 160   0      0
#> 162   0      0
#> 163   0      0
#> 189 128      0
#> 190   0      0
#> 191   0      0
#> 193   0      0
#> 194   0      0
#> 278 128      0
```

``` r
df_notes %>% as_tibble()
#> # A tibble: 263 x 13
#>    i_track meta  type    time channel  note velocity program  ticks     t     m
#>      <dbl> <lgl> <chr>  <dbl>   <dbl> <dbl>    <dbl>   <dbl>  <dbl> <dbl> <dbl>
#>  1       0 FALSE note… 312000       9    36      101     NaN 312000  10.8  16.2
#>  2       0 FALSE note…      0       9    43       72     NaN 312000  10.8  16.2
#>  3       0 FALSE note…      0       9    39       64     NaN 312000  10.8  16.2
#>  4       0 FALSE note…   4800       9    38      101     NaN 316800  11.0  16.5
#>  5       0 FALSE note…      0       9    42      101     NaN 316800  11.0  16.5
#>  6       0 FALSE note…   4800       9    38      101     NaN 321600  11.2  16.7
#>  7       0 FALSE note…      0       9    42      101     NaN 321600  11.2  16.7
#>  8       0 FALSE note…      0       9    43       64     NaN 321600  11.2  16.7
#>  9       0 FALSE note…   4800       9    43       64     NaN 326400  11.3  17  
#> 10       0 FALSE note…      0       9    36      101     NaN 326400  11.3  17  
#> # … with 253 more rows, and 2 more variables: b <dbl>, i_note <int>
```

### Pivot note dataframe to wide

``` r
df_not_notes <- 
  df_notes %>% 
  dplyr::filter(!stringr::str_detect(.data$type, "^note_o[nf]f?$")) 

df_notes_wide <-
  df_notes %>% 
  dplyr::filter(stringr::str_detect(.data$type, "^note_o[nf]f?$")) %>%
  # tab_measures(df_meta, df_notes, ticks_per_beat) %>%
  widen_events() %>%
  left_join(pyramidi::midi_defs)
#> Joining, by = "note"
df_notes_wide
#> # A tibble: 137 x 17
#>    i_track channel  note i_note m_note_off m_note_on b_note_off b_note_on
#>      <dbl>   <dbl> <dbl>  <int>      <dbl>     <dbl>      <dbl>     <dbl>
#>  1       0       9    38      1       16.7      16.5       67.0      66  
#>  2       0       9    42      1       16.7      16.5       67.0      66  
#>  3       0       9    43      1       17        16.7       68        67.0
#>  4       0       9    36      1       17.2      17         69        68  
#>  5       0       9    43      2       17.8      17.5       71        70  
#>  6       0       9    42      2       17.8      17.5       71        70  
#>  7       0       9    36      2       18.2      18         73        72  
#>  8       0       9    43      3       18.2      18         73        72  
#>  9       0       9    39      1       18.2      18         73        72  
#> 10       0       9    38      2       18.8      18.5       75        74.0
#> # … with 127 more rows, and 9 more variables: t_note_off <dbl>,
#> #   t_note_on <dbl>, ticks_note_off <dbl>, ticks_note_on <dbl>,
#> #   time_note_off <dbl>, time_note_on <dbl>, velocity_note_off <dbl>,
#> #   velocity_note_on <dbl>, note_name <fct>
```

### Plot the midi file information in a piano roll plot

``` r
p1 <- df_notes_wide %>%
  ggplot() +
  geom_segment(
    aes(
      x = m_note_on,
      y = note_name,
      xend = m_note_off,
      yend = note_name,
      color = velocity_note_on
    )
  ) +
  # each midi track is printed into its own facet:
  facet_wrap( ~ i_track,
              ncol = 1,
              scales = "free_y")
p1
#> Warning: Removed 13 rows containing missing values (geom_segment).
```

<img src="man/figures/README-midi_piano_roll-1.png" width="100%" />

### Pivot note data frame back to long format

``` r
df_notes_out <-
  df_notes_wide %>%
  select(c("i_track",
           # "name",
           "channel", "note", "i_note"), matches("_note_o[nf]f?$")) %>%
  pivot_longer(matches("_note_o[nf]f?$"),
               names_to = c(".value", "type"),
               names_pattern = "(.+?)_(.*)") %>%
  mutate(meta = FALSE)


df_notes_out <-
  df_notes_out %>%
  full_join(df_meta) %>%
  full_join(df_not_notes) %>%
  arrange(i_track, ticks) %>%
  group_by(i_track) %>%
  mutate(time = ticks - lag(ticks) %>% {.[1] = 0; .}) %>%
  ungroup()
#> Joining, by = c("i_track", "channel", "i_note", "type", "m", "b", "t", "ticks", "time", "meta")
#> Joining, by = c("i_track", "channel", "note", "i_note", "type", "m", "b", "t", "ticks", "time", "velocity", "meta")

df_notes_out
#> # A tibble: 292 x 19
#>    i_track channel  note i_note type      m     b     t  ticks   time velocity
#>      <dbl>   <dbl> <dbl>  <int> <chr> <dbl> <dbl> <dbl>  <dbl>  <dbl>    <dbl>
#>  1       0     NaN    NA      0 trac…   0     0     0        0      0       NA
#>  2       0     NaN    NA      0 inst…   0     0     0        0      0       NA
#>  3       0      10    NA      0 chan…   0     0     0        0      0       NA
#>  4       0     NaN    NA      0 set_…   0     0     0        0      0       NA
#>  5       0     NaN    NA      0 time…   0     0     0        0      0       NA
#>  6       0       9    36      0 note…  16.2  65.0  10.8 312000 312000      101
#>  7       0       9    43      0 note…  16.2  65.0  10.8 312000      0       72
#>  8       0       9    39      0 note…  16.2  65.0  10.8 312000      0       64
#>  9       0       9    38      1 note…  16.5  66    11.0 316800   4800      101
#> 10       0       9    42      1 note…  16.5  66    11.0 316800      0      101
#> # … with 282 more rows, and 8 more variables: meta <lgl>, name <list>,
#> #   tempo <dbl>, numerator <dbl>, denominator <dbl>, clocks_per_click <dbl>,
#> #   notated_32nd_notes_per_beat <dbl>, program <dbl>
```

### Write midi dataframe back to a midi file

``` r
dfc2 <-
  df_notes_out %>%
  select(names(df)) %>%
  # mutate_if(is_numeric, as.integer) %>%
  mutate_if(is.numeric, ~ifelse(is.na(.), NaN, .)) %>%
  mt$compact_df()
```

``` r
dfc2
dfc2 %>%
  mt$df_to_midi(ticks_per_beat,
                "test.mid")
```
